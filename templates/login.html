<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureChat | 加密通讯</title>
    <script src="https://lib.baomitu.com/socket.io/4.0.1/socket.io.min.js"></script>
    <script src="https://lib.baomitu.com/vue/3.2.47/vue.global.prod.min.js"></script>
    <link href="https://lib.baomitu.com/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* --- 全局重置 --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        [v-cloak] { display: none; }
        body { background: #f0f2f5; overflow: hidden; }

        /* --- 登录页美化 (核心部分) --- */
        .login-wrapper {
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            /* 酷炫的渐变背景 */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
        }
        
        /* 增加一些背景漂浮球，增加层次感 */
        .login-wrapper::before {
            content: ''; position: absolute; top: -10%; left: -10%; width: 500px; height: 500px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.95);
            width: 400px;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            z-index: 10;
        }

        .auth-card h2 {
            margin-bottom: 10px; color: #333; font-weight: 700;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .auth-card p.subtitle { color: #888; font-size: 14px; margin-bottom: 30px; }

        /* 输入框美化 */
        .input-group { position: relative; margin-bottom: 20px; text-align: left; }
        .input-group i {
            position: absolute; top: 50%; left: 15px; transform: translateY(-50%); color: #aaa;
        }
        .auth-input {
            width: 100%;
            padding: 12px 15px 12px 45px; /* 留出图标位置 */
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 15px;
            transition: border-color 0.3s;
            outline: none;
            background: #f9f9f9;
        }
        .auth-input:focus { border-color: #764ba2; background: #fff; }

        /* 按钮美化 */
        .btn-primary {
            width: 100%;
            padding: 12px;
            background: linear-gradient(to right, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4); }
        .btn-primary:active { transform: translateY(0); }

        /* 切换 登录/注册 */
        .switch-mode { margin-top: 20px; font-size: 14px; color: #666; }
        .switch-mode a { color: #764ba2; font-weight: bold; cursor: pointer; text-decoration: none; }
        .switch-mode a:hover { text-decoration: underline; }

        .error-tip {
            background: #ffe6e6; color: #d63031; padding: 10px; border-radius: 8px;
            font-size: 13px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;
        }

        /* --- 聊天主界面布局 (保持简洁) --- */
        .app-layout { display: flex; height: 100vh; background: #fff; }
        
        /* 侧边栏 */
        .sidebar { width: 280px; background: #f7f7f7; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; }
        .sidebar-header {
            padding: 20px; background: #fff; border-bottom: 1px solid #eee;
            display: flex; align-items: center; justify-content: space-between;
        }
        .user-info { font-weight: bold; color: #333; display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 10px; height: 10px; background: #2ecc71; border-radius: 50%; }
        
        .friend-list { flex: 1; overflow-y: auto; padding: 10px; }
        .friend-item {
            padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px;
            color: #555; transition: background 0.2s;
        }
        .friend-item:hover { background: #e9eff5; }
        .friend-item.active { background: #e0ebf5; color: #007bff; font-weight: 600; }
        .friend-avatar {
            width: 35px; height: 35px; background: #ddd; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold;
        }

        .sidebar-tools { padding: 15px; border-top: 1px solid #eee; background: #fff; display: flex; gap: 10px; }
        .tool-btn { flex: 1; padding: 8px; border: 1px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .tool-btn:hover { background: #f5f5f5; }

        /* 聊天区 */
        .chat-main { flex: 1; display: flex; flex-direction: column; background: #fff; }
        .chat-topbar {
            padding: 15px 25px; border-bottom: 1px solid #eee; font-size: 16px; font-weight: 600; color: #333;
            background: #fff; display: flex; align-items: center; gap: 10px;
        }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; background: #f0f2f5; display: flex; flex-direction: column; gap: 15px; }
        
        .message-bubble { max-width: 60%; padding: 12px 16px; border-radius: 12px; position: relative; font-size: 14px; line-height: 1.5; }
        .msg-sent { align-self: flex-end; background: #0084ff; color: white; border-bottom-right-radius: 2px; }
        .msg-received { align-self: flex-start; background: #fff; color: #333; border-bottom-left-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg-meta { font-size: 11px; opacity: 0.8; margin-bottom: 4px; display: flex; justify-content: space-between; gap: 10px; }

        .chat-input { padding: 20px; background: #fff; border-top: 1px solid #eee; display: flex; gap: 15px; align-items: center; }
        .chat-input input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; outline: none; background: #f9f9f9; }
        .chat-input button { padding: 10px 20px; background: #0084ff; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .chat-input button:disabled { background: #ccc; cursor: not-allowed; }

        /* 弹窗通用 */
        .modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .modal-box { background: white; padding: 25px; border-radius: 12px; width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: popIn 0.3s ease; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-btn-group { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        .btn-sm { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; }
        .btn-confirm { background: #2ecc71; color: white; }
        .btn-cancel { background: #e74c3c; color: white; }
    </style>
</head>
<body>

<div id="app" v-cloak>

    <div v-if="!isLoggedIn" class="login-wrapper">
        <div class="auth-card">
            <h2><i class="fa-solid fa-shield-halved"></i> SecureChat</h2>
            <p class="subtitle">端到端加密 · 安全 · 隐私</p>

            <div v-if="errorMsg" class="error-tip">
                <i class="fa-solid fa-circle-exclamation"></i> [[ errorMsg ]]
            </div>

            <div class="input-group">
                <i class="fa-solid fa-user"></i>
                <input type="text" v-model="loginForm.username" class="auth-input" placeholder="请输入用户名">
            </div>
            <div class="input-group">
                <i class="fa-solid fa-lock"></i>
                <input type="password" v-model="loginForm.password" class="auth-input" placeholder="请输入密码">
            </div>

            <div v-if="authMode === 'login'">
                <button @click="doLogin" class="btn-primary">立即登录</button>
                <div class="switch-mode">
                    还没有账号？ <a @click="toggleMode">去注册</a>
                </div>
            </div>

            <div v-else>
                <button @click="doRegister" class="btn-primary" style="background: linear-gradient(to right, #11998e, #38ef7d);">注册账号</button>
                <div class="switch-mode">
                    已有账号？ <a @click="toggleMode">去登录</a>
                </div>
            </div>
        </div>
    </div>

    <div v-else class="app-layout">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <div class="status-dot"></div> [[ username ]]
                </div>
                <div>
                    <i class="fa-solid fa-user-plus" style="cursor:pointer; color:#666; margin-right:10px" @click="showModal('add')" title="添加好友"></i>
                    <i class="fa-solid fa-bell" style="cursor:pointer; color:#666" @click="showModal('req')" title="消息验证"></i>
                    <span v-if="pendingRequests.length > 0" style="background:red; color:white; font-size:10px; padding:2px 5px; border-radius:10px; vertical-align:top;">[[pendingRequests.length]]</span>
                </div>
            </div>

            <div class="friend-list">
                <div v-for="friend in friends" :key="friend" 
                     class="friend-item" :class="{ active: currentTarget === friend }"
                     @click="selectFriend(friend)">
                    <div class="friend-avatar" :style="{background: getColor(friend)}">
                        [[ friend.charAt(0).toUpperCase() ]]
                    </div>
                    <span>[[ friend ]]</span>
                </div>
            </div>

            <div class="sidebar-tools">
                <button class="tool-btn" @click="simpleAlert('演示功能：可搜索加密 (SSE)')"><i class="fa-solid fa-magnifying-glass"></i> 密态搜索</button>
                <button class="tool-btn" @click="simpleAlert('演示功能：隐私计算 (MPC)')"><i class="fa-solid fa-coins"></i> 薪资计算</button>
            </div>
        </div>

        <div class="chat-main">
            <div class="chat-topbar">
                <div v-if="currentTarget">
                    <div class="friend-avatar" style="width:30px; height:30px; font-size:12px; display:inline-flex; vertical-align:middle; margin-right:10px;" :style="{background: getColor(currentTarget)}">
                        [[ currentTarget.charAt(0).toUpperCase() ]]
                    </div>
                    [[ currentTarget ]]
                </div>
                <div v-else>未选择会话</div>
            </div>

            <div class="chat-messages" id="msg-box">
                <div v-for="(msg, index) in messages" :key="index" 
                     class="message-bubble" :class="msg.sender === username ? 'msg-sent' : 'msg-received'">
                    <div class="msg-meta">
                        <span>[[ msg.sender ]]</span>
                        <i v-if="msg.is_encrypted" class="fa-solid fa-lock" title="端到端加密"></i>
                    </div>
                    [[ msg.content ]]
                </div>
            </div>

            <div class="chat-input">
                <input type="text" v-model="inputMsg" @keyup.enter="sendMessage" 
                       placeholder="发送加密消息..." :disabled="!currentTarget">
                <button @click="sendMessage" :disabled="!currentTarget">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <div v-if="modals.add" class="modal-mask" @click.self="modals.add = false">
        <div class="modal-box">
            <div class="modal-title">添加好友</div>
            <input v-model="searchTarget" class="auth-input" placeholder="输入对方用户名" style="padding:10px;">
            <div class="modal-btn-group">
                <button @click="modals.add = false" class="btn-sm btn-cancel">取消</button>
                <button @click="sendFriendRequest" class="btn-sm btn-confirm">发送请求</button>
            </div>
        </div>
    </div>

    <div v-if="modals.req" class="modal-mask" @click.self="modals.req = false">
        <div class="modal-box">
            <div class="modal-title">好友请求</div>
            <div v-if="pendingRequests.length === 0" style="color:#999; text-align:center;">暂无新请求</div>
            <div v-for="req in pendingRequests" class="friend-item" style="cursor:default; justify-content:space-between;">
                <span>[[ req.from_user ]]</span>
                <div style="display:flex; gap:5px;">
                    <button @click="handleReq(req.id, 'accept')" class="btn-sm btn-confirm"><i class="fa-solid fa-check"></i></button>
                    <button @click="handleReq(req.id, 'reject')" class="btn-sm btn-cancel"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>
            <div class="modal-btn-group">
                <button @click="modals.req = false" class="btn-sm" style="background:#eee;color:#333">关闭</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp } = Vue;

    createApp({
        compilerOptions: { delimiters: ['[[', ']]'] },
        data() {
            return {
                isLoggedIn: false,
                authMode: 'login', // 控制登录/注册切换
                username: "",
                loginForm: { username: "", password: "" },
                errorMsg: "",
                
                socket: null,
                friends: [],
                messages: [],
                pendingRequests: [],
                currentTarget: null,
                inputMsg: '',
                searchTarget: '',
                modals: { add: false, req: false },
                avatarColors: ['#3498db', '#e74c3c', '#9b59b6', '#f1c40f', '#1abc9c', '#34495e']
            }
        },
        mounted() { this.checkLoginStatus(); },
        methods: {
            async post(url, data) {
                try {
                    const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
                    return await res.json();
                } catch(e) { return {status:'error', msg:'网络错误'}; }
            },
            toggleMode() {
                this.authMode = this.authMode === 'login' ? 'register' : 'login';
                this.errorMsg = "";
                this.loginForm = { username: "", password: "" };
            },
            async checkLoginStatus() {
                const res = await fetch('/api/friends');
                if (res.ok) {
                    const data = await res.json();
                    if (Array.isArray(data)) {
                        this.isLoggedIn = true;
                        this.username = "{{ username }}"; 
                        if(this.username.includes("{") || !this.username) this.username = ""; 
                        if(this.username) {
                            this.friends = data;
                            this.initSocket();
                        } else {
                            // 如果后端 session 过期但前端还在，强制登出
                            this.isLoggedIn = false;
                        }
                    }
                }
            },
            async doLogin() {
                if(!this.loginForm.username || !this.loginForm.password) return;
                const data = await this.post('/api/login', this.loginForm);
                if (data.status === 'ok') {
                    this.username = this.loginForm.username;
                    this.isLoggedIn = true;
                    this.loadFriends();
                    this.initSocket();
                } else this.errorMsg = data.msg;
            },
            async doRegister() {
                if(!this.loginForm.username || !this.loginForm.password) return;
                const data = await this.post('/api/register', this.loginForm);
                if (data.status === 'ok') {
                    alert("注册成功，请直接登录");
                    this.toggleMode(); // 切换回登录界面
                } else this.errorMsg = data.msg;
            },
            // ... (Socket 和 消息逻辑保持与之前一致) ...
            async loadFriends() {
                const res = await fetch('/api/friends');
                this.friends = await res.json();
            },
            initSocket() {
                this.socket = io();
                this.socket.on('new_message', (data) => {
                    const roomName = this.getRoomName(data.sender === this.username ? this.currentTarget : data.sender);
                    this.saveMessageToLocal(roomName, data);
                    if (this.currentTarget && roomName === this.getRoomName(this.currentTarget)) {
                        this.messages.push(data);
                        this.scrollToBottom();
                    }
                });
                this.socket.on('history_messages', (msgs) => {
                    if (this.currentTarget) {
                        this.messages = msgs;
                        const roomName = this.getRoomName(this.currentTarget);
                        localStorage.setItem('chat_' + roomName, JSON.stringify(msgs));
                        this.scrollToBottom();
                    }
                });
                this.socket.on('new_request_notify', () => { 
                    // 这里可以加一个小红点逻辑
                    this.checkRequests(); 
                });
                this.checkRequests(); // 连上时检查一下
            },
            selectFriend(name) {
                this.currentTarget = name;
                this.messages = [];
                const roomName = this.getRoomName(name);
                const localHistory = localStorage.getItem('chat_' + roomName);
                if (localHistory) { this.messages = JSON.parse(localHistory); this.scrollToBottom(); }
                this.socket.emit('join_chat', { target: name });
            },
            sendMessage() {
                if (!this.inputMsg || !this.currentTarget) return;
                this.socket.emit('send_message', { target: this.currentTarget, content: this.inputMsg });
                this.inputMsg = '';
            },
            getRoomName(target) { return [this.username, target].sort().join('_'); },
            saveMessageToLocal(room, msg) {
                let history = JSON.parse(localStorage.getItem('chat_' + room) || "[]");
                history.push(msg);
                if(history.length > 100) history = history.slice(history.length - 100);
                localStorage.setItem('chat_' + room, JSON.stringify(history));
            },
            async sendFriendRequest() { await this.post('/api/requests', {target:this.searchTarget}); this.modals.add=false; alert("已发送"); },
            async checkRequests() { const res = await fetch('/api/requests'); this.pendingRequests = await res.json(); },
            async handleReq(id, action) { await this.post('/api/handle_request', {req_id:id, action:action}); this.checkRequests(); this.loadFriends(); },
            showModal(type) { if(type==='req')this.checkRequests(); this.modals[type]=true; },
            scrollToBottom() { this.$nextTick(() => { const b=document.getElementById('msg-box'); if(b) b.scrollTop=b.scrollHeight; }); },
            getColor(name) {
                // 根据名字生成固定的头像颜色
                let hash = 0;
                for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
                return this.avatarColors[Math.abs(hash) % this.avatarColors.length];
            },
            simpleAlert(msg) { alert(msg); }
        }
    }).mount('#app');
</script>
</body>
</html>